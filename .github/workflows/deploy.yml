# name: Deploy React App to GitHub Pages

# on:
#   schedule:
#     - cron: "*/15 * * * *" # run every 15 minutes automatically
#   workflow_dispatch: # allow manual run button
#   push:
#     branches:
#       - main # optional: still deploy when code changes

# permissions:
#   contents: write

# jobs:
#   build-and-deploy:
#     runs-on: self-hosted

#     steps:
#       # 1️⃣ Checkout repo
#       - name: Checkout repository
#         uses: actions/checkout@v4

#       # 2️⃣ Setup Node
#       - name: Setup Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: 18

#       # 3️⃣ Install dependencies
#       - name: Install dependencies
#         run: npm install

#       # 4️⃣ Copy CSVs + generate files.json (WINDOWS SAFE)
#       - name: Update CSVs from OneDrive & generate files.json
#         shell: powershell
#         run: |
#           $ONEDRIVE_PATH="D:\One drive\OneDrive - FUJITSU\IN - OneAsia1 BPS PM - FY 25-26"

#           # Ensure destination exists
#           New-Item -ItemType Directory -Force -Path public/api/sharepoint | Out-Null

#           # Copy CSV files (ignore if none)
#           Copy-Item "$ONEDRIVE_PATH\Demand Tracker_New Transitions\*.csv" public/api/sharepoint -ErrorAction SilentlyContinue
#           Copy-Item "$ONEDRIVE_PATH\Ramp Down Tracker\*.csv" public/api/sharepoint -ErrorAction SilentlyContinue

#           # Generate files.json dynamically
#           $files = Get-ChildItem public/api/sharepoint -Filter *.csv | Select-Object -ExpandProperty Name
#           $json = @{ files = $files } | ConvertTo-Json -Depth 2
#           $json | Out-File public/api/files.json -Encoding utf8

#           Write-Host "Generated files.json:"
#           Get-Content public/api/files.json

#       # 5️⃣ Build React app
#       - name: Build project
#         run: npm run build

#       # 6️⃣ Deploy to gh-pages
#       - name: Deploy to gh-pages branch
#         uses: peaceiris/actions-gh-pages@v4
#         with:
#           github_token: ${{ secrets.GITHUB_TOKEN }}
#           publish_dir: ./build

# name: Deploy React App to GitHub Pages

# on:
#   schedule:
#     - cron: "*/15 * * * *" # run every 15 minutes automatically
#   workflow_dispatch: # manual trigger
#   push:
#     branches:
#       - main

# permissions:
#   contents: write

# jobs:
#   build-and-deploy:
#     runs-on: self-hosted

#     steps:
#       # 1️⃣ Checkout repository
#       - name: Checkout repository
#         uses: actions/checkout@v4

#       # 2️⃣ Setup Node.js
#       - name: Setup Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: 18

#       # 3️⃣ Clean old build and node_modules (Windows CMD)
#       - name: Clean build and node_modules (Windows CMD)
#         shell: cmd
#         run: |
#           if exist build rmdir /s /q build
#           if exist node_modules rmdir /s /q node_modules

#       # 4️⃣ Install dependencies
#       - name: Install dependencies
#         run: npm install

#       # 5️⃣ Copy CSVs + generate files.json (PowerShell)
#       - name: Update CSVs from OneDrive & generate files.json
#         shell: powershell
#         run: |
#           $ONEDRIVE_PATH="D:\One drive\OneDrive - FUJITSU\IN - OneAsia1 BPS PM - FY 25-26"

#           # Ensure destination exists
#           New-Item -ItemType Directory -Force -Path public/api/sharepoint | Out-Null

#           # Copy CSV files (ignore if none)
#           Copy-Item "$ONEDRIVE_PATH\Demand Tracker_New Transitions\*.csv" public/api/sharepoint -ErrorAction SilentlyContinue
#           Copy-Item "$ONEDRIVE_PATH\Ramp Down Tracker\*.csv" public/api/sharepoint -ErrorAction SilentlyContinue

#           # Generate files.json dynamically
#           $files = Get-ChildItem public/api/sharepoint -Filter *.csv | Select-Object -ExpandProperty Name
#           $json = @{ files = $files } | ConvertTo-Json -Depth 2
#           $json | Out-File public/api/files.json -Encoding utf8

#           Write-Host "Generated files.json:"
#           Get-Content public/api/files.json

#       # 6️⃣ Build React app
#       - name: Build project
#         run: npm run build

#       # 7️⃣ Deploy to gh-pages
#       - name: Deploy to gh-pages branch
#         uses: peaceiris/actions-gh-pages@v4
#         with:
#           github_token: ${{ secrets.GITHUB_TOKEN }}
#           publish_dir: ./build

name: Deploy React App to GitHub Pages

on:
  schedule:
    - cron: "*/15 * * * *" # Checks every 15 minutes for CSV updates
  workflow_dispatch: # Manual trigger for testing or JSX push
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
      # ----------------------------------------
      # 1️⃣ Checkout repository
      # ----------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ----------------------------------------
      # 2️⃣ Setup Node.js
      # ----------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # ----------------------------------------
      # 3️⃣ Detect changes (CSV or JSX/JS) in CMD
      # ----------------------------------------
      - name: Determine if build is needed
        shell: cmd
        run: |
          git fetch origin main

          REM -- Check if any JSX/JS files changed
          set CHANGED_JSX=
          for /f "delims=" %%i in ('git diff --name-only origin/main') do (
            set CHANGED_JSX=%%i
          )

          REM -- Always rebuild for JSX/JS changes
          if defined CHANGED_JSX (
            echo JSX/JS changes detected
            set build_needed=true
          ) else (
            echo No JSX/JS changes detected yet, will check CSV next
            set build_needed=false
          )

      # ----------------------------------------
      # 4️⃣ Copy CSVs from OneDrive & check if changed
      # ----------------------------------------
      - name: Copy CSVs & detect changes
        shell: powershell
        run: |
          $ONEDRIVE_PATH="D:\One drive\OneDrive - FUJITSU\IN - OneAsia1 BPS PM - FY 25-26"
          $DEST_PATH="public/api/sharepoint"

          # Ensure destination exists
          New-Item -ItemType Directory -Force -Path $DEST_PATH | Out-Null

          # Track CSV changes
          $csvChanged = $false

          # Copy CSVs from OneDrive
          $csvFiles = Get-ChildItem "$ONEDRIVE_PATH\Demand Tracker_New Transitions\*.csv"
          foreach ($file in $csvFiles) {
            $destFile = Join-Path $DEST_PATH $file.Name
            if (!(Test-Path $destFile) -or ((Get-FileHash $file.FullName).Hash -ne (Get-FileHash $destFile).Hash)) {
              Copy-Item $file.FullName $destFile -Force
              $csvChanged = $true
            }
          }

          $csvFiles2 = Get-ChildItem "$ONEDRIVE_PATH\Ramp Down Tracker\*.csv"
          foreach ($file in $csvFiles2) {
            $destFile = Join-Path $DEST_PATH $file.Name
            if (!(Test-Path $destFile) -or ((Get-FileHash $file.FullName).Hash -ne (Get-FileHash $destFile).Hash)) {
              Copy-Item $file.FullName $destFile -Force
              $csvChanged = $true
            }
          }

          # Generate files.json dynamically
          $files = Get-ChildItem $DEST_PATH -Filter *.csv | Select-Object -ExpandProperty Name
          $json = @{ files = $files } | ConvertTo-Json -Depth 2
          $json | Out-File "$DEST_PATH/../files.json" -Encoding utf8

          if ($csvChanged) {
            Write-Host "CSV changes detected. React build will run."
            echo "##vso[task.setvariable variable=build_needed]true"
          } else {
            Write-Host "No CSV changes detected."
          }

      # ----------------------------------------
      # 5️⃣ Build React app (only if CSV/JSX changed)
      # ----------------------------------------
      - name: Build project
        if: env.build_needed == 'true'
        shell: cmd
        run: |
          echo Running React build due to CSV or JSX changes...
          npm install
          npm run build

      # ----------------------------------------
      # 6️⃣ Deploy to GH Pages
      # ----------------------------------------
      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build
          keep_files: true
