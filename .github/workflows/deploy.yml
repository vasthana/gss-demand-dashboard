# name: Deploy React App to GitHub Pages

# on:
#   schedule:
#     - cron: "*/15 * * * *" # run every 15 minutes automatically
#   workflow_dispatch: # allow manual run button
#   push:
#     branches:
#       - main # optional: still deploy when code changes

# permissions:
#   contents: write

# jobs:
#   build-and-deploy:
#     runs-on: self-hosted

#     steps:
#       # 1️⃣ Checkout repo
#       - name: Checkout repository
#         uses: actions/checkout@v4

#       # 2️⃣ Setup Node
#       - name: Setup Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: 18

#       # 3️⃣ Install dependencies
#       - name: Install dependencies
#         run: npm install

#       # 4️⃣ Copy CSVs + generate files.json (WINDOWS SAFE)
#       - name: Update CSVs from OneDrive & generate files.json
#         shell: powershell
#         run: |
#           $ONEDRIVE_PATH="D:\One drive\OneDrive - FUJITSU\IN - OneAsia1 BPS PM - FY 25-26"

#           # Ensure destination exists
#           New-Item -ItemType Directory -Force -Path public/api/sharepoint | Out-Null

#           # Copy CSV files (ignore if none)
#           Copy-Item "$ONEDRIVE_PATH\Demand Tracker_New Transitions\*.csv" public/api/sharepoint -ErrorAction SilentlyContinue
#           Copy-Item "$ONEDRIVE_PATH\Ramp Down Tracker\*.csv" public/api/sharepoint -ErrorAction SilentlyContinue

#           # Generate files.json dynamically
#           $files = Get-ChildItem public/api/sharepoint -Filter *.csv | Select-Object -ExpandProperty Name
#           $json = @{ files = $files } | ConvertTo-Json -Depth 2
#           $json | Out-File public/api/files.json -Encoding utf8

#           Write-Host "Generated files.json:"
#           Get-Content public/api/files.json

#       # 5️⃣ Build React app
#       - name: Build project
#         run: npm run build

#       # 6️⃣ Deploy to gh-pages
#       - name: Deploy to gh-pages branch
#         uses: peaceiris/actions-gh-pages@v4
#         with:
#           github_token: ${{ secrets.GITHUB_TOKEN }}
#           publish_dir: ./build

# name: Deploy React App to GitHub Pages

# on:
#   schedule:
#     - cron: "*/15 * * * *" # run every 15 minutes automatically
#   workflow_dispatch: # manual trigger
#   push:
#     branches:
#       - main

# permissions:
#   contents: write

# jobs:
#   build-and-deploy:
#     runs-on: self-hosted

#     steps:
#       # 1️⃣ Checkout repository
#       - name: Checkout repository
#         uses: actions/checkout@v4

#       # 2️⃣ Setup Node.js
#       - name: Setup Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: 18

#       # 3️⃣ Clean old build and node_modules (Windows CMD)
#       - name: Clean build and node_modules (Windows CMD)
#         shell: cmd
#         run: |
#           if exist build rmdir /s /q build
#           if exist node_modules rmdir /s /q node_modules

#       # 4️⃣ Install dependencies
#       - name: Install dependencies
#         run: npm install

#       # 5️⃣ Copy CSVs + generate files.json (PowerShell)
#       - name: Update CSVs from OneDrive & generate files.json
#         shell: powershell
#         run: |
#           $ONEDRIVE_PATH="D:\One drive\OneDrive - FUJITSU\IN - OneAsia1 BPS PM - FY 25-26"

#           # Ensure destination exists
#           New-Item -ItemType Directory -Force -Path public/api/sharepoint | Out-Null

#           # Copy CSV files (ignore if none)
#           Copy-Item "$ONEDRIVE_PATH\Demand Tracker_New Transitions\*.csv" public/api/sharepoint -ErrorAction SilentlyContinue
#           Copy-Item "$ONEDRIVE_PATH\Ramp Down Tracker\*.csv" public/api/sharepoint -ErrorAction SilentlyContinue

#           # Generate files.json dynamically
#           $files = Get-ChildItem public/api/sharepoint -Filter *.csv | Select-Object -ExpandProperty Name
#           $json = @{ files = $files } | ConvertTo-Json -Depth 2
#           $json | Out-File public/api/files.json -Encoding utf8

#           Write-Host "Generated files.json:"
#           Get-Content public/api/files.json

#       # 6️⃣ Build React app
#       - name: Build project
#         run: npm run build

#       # 7️⃣ Deploy to gh-pages
#       - name: Deploy to gh-pages branch
#         uses: peaceiris/actions-gh-pages@v4
#         with:
#           github_token: ${{ secrets.GITHUB_TOKEN }}
#           publish_dir: ./build

name: Deploy React App to GitHub Pages

on:
  schedule:
    - cron: "*/15 * * * *" # Automatic run every 15 minutes
  workflow_dispatch: # Manual trigger
    inputs:
      test_csv:
        description: "Set to true to test CSV update immediately"
        required: false
        default: "false"
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: self-hosted
    steps:
      # ----------------------------------------
      # 1️⃣ Checkout repository
      # ----------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ----------------------------------------
      # 2️⃣ Setup Node.js
      # ----------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # ----------------------------------------
      # 3️⃣ Detect if rebuild is needed (CMD)
      # ----------------------------------------
      - name: Determine if build is needed
        shell: cmd
        run: |
          git fetch origin main
          set CHANGED=
          for /f "delims=" %%i in ('git diff --name-only origin/main') do set CHANGED=%%i
          echo Changed files: %CHANGED%

          REM -- Always rebuild if test_csv is true, CSV changes, or JSX/JS changes
          if "%GITHUB_EVENT_INPUTS_test_csv%"=="true" (
              echo Test CSV run: build will run
              set build_needed=true
          ) else (
              echo Changes detected, build will run to reflect CSV or JSX updates
              set build_needed=true
          )

      # ----------------------------------------
      # 4️⃣ Copy CSVs & generate files.json (PowerShell)
      # ----------------------------------------
      - name: Update CSVs from OneDrive & generate files.json
        shell: powershell
        run: |
          $ONEDRIVE_PATH="D:\One drive\OneDrive - FUJITSU\IN - OneAsia1 BPS PM - FY 25-26"

          # Ensure destination exists
          New-Item -ItemType Directory -Force -Path build/api/sharepoint | Out-Null

          # Copy CSV files (ignore if none)
          Copy-Item "$ONEDRIVE_PATH\Demand Tracker_New Transitions\*.csv" build/api/sharepoint -ErrorAction SilentlyContinue
          Copy-Item "$ONEDRIVE_PATH\Ramp Down Tracker\*.csv" build/api/sharepoint -ErrorAction SilentlyContinue

          # Generate files.json dynamically
          $files = Get-ChildItem build/api/sharepoint -Filter *.csv | Select-Object -ExpandProperty Name
          $json = @{ files = $files } | ConvertTo-Json -Depth 2
          $json | Out-File build/api/files.json -Encoding utf8

      # ----------------------------------------
      # 5️⃣ Build React app (for any CSV or JSX/JS changes)
      # ----------------------------------------
      - name: Build project
        if: env.build_needed == 'true'
        shell: cmd
        run: |
          echo Running full build to reflect CSV/JSX changes...
          npm install
          npm run build

      # ----------------------------------------
      # 6️⃣ Deploy to gh-pages (always runs)
      # ----------------------------------------
      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build
          keep_files: true
