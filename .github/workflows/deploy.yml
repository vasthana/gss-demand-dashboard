name: Deploy React App to GitHub Pages

on:
  schedule:
    - cron: "*/15 * * * *" # Automatic run every 15 minutes for CSV updates
  workflow_dispatch: # Manual trigger (can be used for JSX/JS build)
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  # ----------------------------------------
  # CSV Auto-Update Job
  # ----------------------------------------
  csv-deploy:
    runs-on: self-hosted
    outputs:
      build_needed: ${{ steps.set_build_needed.outputs.build_needed }}
    steps:
      # 1️⃣ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Setup Node.js (needed only if later building JSX)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # 3️⃣ Copy CSVs & generate files.json
      - name: Update CSVs from OneDrive & generate files.json
        id: set_build_needed
        shell: powershell
        run: |
          $ONEDRIVE_PATH="D:\One drive\OneDrive - FUJITSU\IN - OneAsia1 BPS PM - FY 25-26"
          $DEST_PATH="build/api/sharepoint"
          New-Item -ItemType Directory -Force -Path $DEST_PATH | Out-Null

          $csvChanged = $false

          # Copy CSVs from Demand Tracker_New Transitions
          $csvFiles = Get-ChildItem "$ONEDRIVE_PATH\Demand Tracker_New Transitions\*.csv"
          foreach ($file in $csvFiles) {
            $destFile = Join-Path $DEST_PATH $file.Name
            if (!(Test-Path $destFile) -or ((Get-FileHash $file.FullName).Hash -ne (Get-FileHash $destFile).Hash)) {
              Copy-Item $file.FullName $destFile -Force
              $csvChanged = $true
            }
          }

          # Copy CSVs from Ramp Down Tracker
          $csvFiles2 = Get-ChildItem "$ONEDRIVE_PATH\Ramp Down Tracker\*.csv"
          foreach ($file in $csvFiles2) {
            $destFile = Join-Path $DEST_PATH $file.Name
            if (!(Test-Path $destFile) -or ((Get-FileHash $file.FullName).Hash -ne (Get-FileHash $destFile).Hash)) {
              Copy-Item $file.FullName $destFile -Force
              $csvChanged = $true
            }
          }

          # Generate files.json dynamically
          $files = Get-ChildItem $DEST_PATH -Filter *.csv | Select-Object -ExpandProperty Name
          $json = @{ files = $files } | ConvertTo-Json -Depth 2
          $json | Out-File "$DEST_PATH/../files.json" -Encoding utf8

          # Export job output for conditional build
          if ($csvChanged) {
            Write-Host "CSV changes detected"
            echo "::set-output name=build_needed::true"
          } else {
            Write-Host "No CSV changes detected"
            echo "::set-output name=build_needed::false"
          }

      # 4️⃣ Deploy CSV changes (no rebuild)
      - name: Deploy CSV changes
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build
          keep_files: true # ⚡ Only updates CSVs, keeps existing build intact

  # ----------------------------------------
  # Full Build Job (JSX/JS changes or CSV changes)
  # ----------------------------------------
  build-and-deploy:
    needs: csv-deploy
    runs-on: self-hosted
    if: needs.csv-deploy.outputs.build_needed == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'push'
    steps:
      # 1️⃣ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # 3️⃣ Install dependencies
      - name: Install dependencies
        run: npm install

      # 4️⃣ Build project (for JSX/JS or CSV updates)
      - name: Build project
        run: npm run build

      # 5️⃣ Deploy full build
      - name: Deploy full build
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build
